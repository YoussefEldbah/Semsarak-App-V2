<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0" style="font-weight: 700; color: #1e3a8a;"><i class="fas fa-building me-2 text-info"></i>My Properties</h2>
    <button *ngIf="user?.role === 'Owner' || (user?.roles && user.roles.includes('Owner'))" class="btn btn-primary btn-lg fw-bold" (click)="goToAddProperty()" style="box-shadow: 0 4px 12px rgba(30,58,138,0.10);">
      <i class="fas fa-plus me-1"></i> Add Property
    </button>
  </div>
  <div *ngIf="successMessage" class="custom-alert custom-alert-success animate__animated animate__fadeInDown">
    <span class="custom-alert-icon"><i class="fas fa-check-circle"></i></span>
    <span class="custom-alert-text">{{ successMessage }}</span>
    <span class="custom-alert-close" (click)="successMessage = ''">&times;</span>
  </div>
  <div *ngIf="errorMessage" class="custom-alert custom-alert-danger animate__animated animate__fadeInDown">
    <span class="custom-alert-icon"><i class="fas fa-exclamation-circle"></i></span>
    <span class="custom-alert-text">{{ errorMessage }}</span>
    <span class="custom-alert-close" (click)="errorMessage = ''">&times;</span>
  </div>
  <div *ngIf="myProperties.length === 0" class="alert alert-info text-center py-4" style="font-size: 1.2rem;">
    You have no properties yet. Click <b>Add Property</b> to create your first listing!
  </div>
  <div *ngIf="pendingDeleteId !== null" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn">
      <div class="modal-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div class="modal-title">Delete Property</div>
      <div class="modal-message">Are you sure you want to delete this property? This action cannot be undone.</div>
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="confirmDelete()"><i class="fas fa-trash me-1"></i> Delete</button>
        <button class="btn btn-secondary ms-2" (click)="cancelDelete()">Cancel</button>
      </div>
    </div>
  </div>
  <div *ngIf="myProperties.length === 0" class="alert alert-info text-center py-4" style="font-size: 1.2rem;">
    You have no properties yet. Click <b>Add Property</b> to create your first listing!
  </div>
  <div class="row g-4">
    <div class="col-md-6 col-lg-4" *ngFor="let property of myProperties">
      <div class="card shadow property-card border-0 rounded-4 h-100 position-relative">
        <!-- شارة حالة العقار -->
        <span class="property-status-badge position-absolute top-0 end-0 m-3" [ngClass]="{
          'available': property.status === 'Available',
          'pending': property.status === 'Pending',
          'sold': property.status === 'Sold'
        }">
          <i class="fas fa-info-circle me-1"></i> {{ property.status }}
        </span>
        <!-- سلايدر صور العقار -->
        <div *ngIf="property.imagePaths && property.imagePaths.length" class="property-carousel-wrapper">
          <div id="property-carousel-{{property.id}}" class="carousel slide property-carousel" data-bs-ride="carousel">
            <div class="carousel-inner">
              <div *ngFor="let img of property.imagePaths; let i = index" class="carousel-item" [class.active]="i === 0">
                <img [src]="getImageUrl(img)" class="d-block w-100 property-carousel-img" alt="Property Image">
                <div class="carousel-img-index">{{ i + 1 }} / {{ property.imagePaths.length }}</div>
              </div>
            </div>
            <button class="carousel-control-prev" type="button" [attr.data-bs-target]="'#property-carousel-' + property.id" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" [attr.data-bs-target]="'#property-carousel-' + property.id" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
        <div class="card-body py-3">
          <h5 class="card-title mb-3 property-title">
            <i class="fas fa-home me-2 text-primary"></i>{{ property.title }}
          </h5>
          <div class="property-detail-row mb-2">
            <i class="fas fa-map-marker-alt me-1 text-danger"></i>
            <span><strong>City:</strong> {{ property.city }}</span>
            <span class="mx-2">|</span>
            <span><strong>Region:</strong> {{ property.region }}</span>
          </div>
          <div class="property-detail-row mb-2">
            <i class="fas fa-door-open me-1 text-secondary"></i>
            <span><strong>Rooms:</strong> {{ property.roomsCount }} غرفة</span>
          </div>
          <div class="property-detail-row mb-2">
            <i class="fas fa-money-bill-wave me-1 text-success"></i>
            <span><strong>Price:</strong> {{ property.price | currency:'USD':'symbol':'1.0-0' }}</span>
          </div>
        </div>
        <!-- شريط الأزرار السفلي -->
        <div class="property-btn-bar d-flex justify-content-between align-items-center px-3 pb-3 gap-2">
          <button class="btn btn-warning property-btn" (click)="startEditProperty(property)">
            <i class="fas fa-edit me-1"></i> <span class="d-none d-sm-inline">Edit</span>
          </button>
          <button class="btn btn-info text-white property-btn" (click)="startEditImages(property)">
            <i class="fas fa-images me-1"></i> <span class="d-none d-sm-inline">Edit Images</span>
          </button>
          <button class="btn btn-danger property-btn" (click)="deleteProperty(property.id)">
            <i class="fas fa-trash me-1"></i> <span class="d-none d-sm-inline">Delete</span>
          </button>
          <button *ngIf="property.status !== 'Available'" class="btn btn-primary property-btn" (click)="openAdvertiseModal(property)">
            <i class="fas fa-bullhorn me-1"></i> <span class="d-none d-sm-inline">Advertise</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Images Modal -->
  <div *ngIf="editingImagesProperty" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 600px;">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-images me-2 text-primary"></i>
          Edit Images - {{ editingImagesProperty.title }}
        </h5>
        <button type="button" class="btn-close" (click)="cancelEditImages()"></button>
      </div>
      <div class="modal-body">
        <!-- Current Images -->
        <div class="mb-4">
          <h6><i class="fas fa-photo-video me-1"></i> Current Images</h6>
          <div class="row g-2">
            <div class="col-md-4 col-6" *ngFor="let image of editingImagesProperty.images; let i = index">
              <div class="position-relative">
                <img [src]="getImageUrl(image.imagePath)" class="img-fluid rounded" style="width: 100%; height: 120px; object-fit: cover;" alt="Property Image">
                <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                        (click)="openDeleteImageModal(i)"
                        [disabled]="deletingImageIndex === i"
                        style="width: 25px; height: 25px; padding: 0; border-radius: 50%;">
                  <i *ngIf="deletingImageIndex !== i" class="fas fa-times"></i>
                  <i *ngIf="deletingImageIndex === i" class="fas fa-spinner fa-spin"></i>
                </button>
              </div>
            </div>
            <div class="col-12" *ngIf="!editingImagesProperty.images || editingImagesProperty.images.length === 0">
              <div class="text-center text-muted py-3">
                <i class="fas fa-image fa-2x mb-2"></i>
                <p>No images uploaded yet</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Add New Images -->
        <div class="mb-3">
          <h6><i class="fas fa-plus me-1"></i> Add New Images</h6>
          <input type="file" 
                 class="form-control" 
                 (change)="onNewImagesSelected($event)" 
                 multiple 
                 accept="image/*"
                 [disabled]="uploadingImages">
          <small class="text-muted">You can select multiple images. Supported formats: JPG, PNG, GIF</small>
        </div>
        
        <!-- Preview New Images -->
        <div *ngIf="newImages.length > 0" class="mb-3">
          <h6><i class="fas fa-eye me-1"></i> Preview New Images</h6>
          <div class="row g-2">
            <div class="col-md-4 col-6" *ngFor="let image of newImages; let i = index">
              <div class="position-relative">
                <img [src]="image.preview" class="img-fluid rounded" style="width: 100%; height: 120px; object-fit: cover;" alt="Preview">
                <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                        (click)="removeNewImage(i)" 
                        style="width: 25px; height: 25px; padding: 0; border-radius: 50%;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Loading State -->
        <div *ngIf="uploadingImages" class="text-center py-3">
          <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
          <p class="mt-2">Uploading images...</p>
        </div>
        
        <!-- Success/Error Messages -->
        <div *ngIf="imagesSuccessMessage" class="alert alert-success animate__animated animate__fadeInDown">
          <i class="fas fa-check-circle me-1"></i> {{ imagesSuccessMessage }}
        </div>
        <div *ngIf="imagesErrorMessage" class="alert alert-danger animate__animated animate__fadeInDown">
          <i class="fas fa-exclamation-circle me-1"></i> {{ imagesErrorMessage }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEditImages()" [disabled]="uploadingImages">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="saveImages()" [disabled]="uploadingImages || newImages.length === 0">
          <span *ngIf="!uploadingImages"><i class="fas fa-save me-1"></i> Save Images</span>
          <span *ngIf="uploadingImages"><i class="fas fa-spinner fa-spin me-1"></i> Saving...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal تأكيد حذف الصورة -->
  <div *ngIf="showDeleteImageModal" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 400px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close" (click)="closeDeleteImageModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this image? This action cannot be undone.</p>
        <div class="text-center my-2">
          <img *ngIf="editingImagesProperty.images && imageToDeleteIndex !== null && editingImagesProperty.images[imageToDeleteIndex]" [src]="getImageUrl(editingImagesProperty.images[imageToDeleteIndex].imagePath)" style="max-width: 180px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px rgba(220,53,69,0.12);">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteImageModal()">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDeleteImage()" [disabled]="deletingImageIndex === imageToDeleteIndex">
          <span *ngIf="deletingImageIndex !== imageToDeleteIndex"><i class="fas fa-trash me-1"></i>Delete</span>
          <span *ngIf="deletingImageIndex === imageToDeleteIndex"><i class="fas fa-spinner fa-spin me-1"></i>Deleting...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal تعديل العقار -->
  <div *ngIf="editProperty" class="modal-overlay">
    <div class="custom-modal animate__animated animate__zoomIn" style="max-width: 600px;">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-edit me-2"></i>تعديل العقار
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="editProperty = null"></button>
      </div>
      <div class="modal-body p-4">
        <form [formGroup]="editPropertyForm" (ngSubmit)="saveEditProperty()">
          <!-- Property Basic Info -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-home text-primary me-1"></i>عنوان العقار
              </label>
              <input formControlName="title" 
                     class="form-control form-control-lg shadow-sm" 
                     placeholder="أدخل عنوان العقار"
                     [class.is-invalid]="editPropertyForm.get('title')?.invalid && editPropertyForm.get('title')?.touched">
              <div *ngIf="editPropertyForm.get('title')?.invalid && editPropertyForm.get('title')?.touched" class="invalid-feedback">
                العنوان مطلوب
              </div>
            </div>
          </div>

          <!-- Price and Rooms -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-money-bill-wave text-success me-1"></i>السعر (جنيه)
              </label>
              <input formControlName="price" 
                     type="number" 
                     class="form-control form-control-lg shadow-sm" 
                     placeholder="0"
                     min="0"
                     [class.is-invalid]="editPropertyForm.get('price')?.invalid && editPropertyForm.get('price')?.touched">
              <div *ngIf="editPropertyForm.get('price')?.invalid && editPropertyForm.get('price')?.touched" class="invalid-feedback">
                السعر مطلوب
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-door-open text-info me-1"></i>عدد الغرف
              </label>
              <select formControlName="roomsCount" class="form-select form-select-lg shadow-sm">
                <option value="">اختر عدد الغرف</option>
                <option value="1">1 غرفة</option>
                <option value="2">2 غرفة</option>
                <option value="3">3 غرف</option>
                <option value="4">4 غرف</option>
                <option value="5">5+ غرف</option>
              </select>
            </div>
          </div>

          <!-- Location -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-city text-warning me-1"></i>المدينة
              </label>
              <input formControlName="city" 
                     class="form-control form-control-lg shadow-sm" 
                     placeholder="مثال: القاهرة"
                     [class.is-invalid]="editPropertyForm.get('city')?.invalid && editPropertyForm.get('city')?.touched">
              <div *ngIf="editPropertyForm.get('city')?.invalid && editPropertyForm.get('city')?.touched" class="invalid-feedback">
                المدينة مطلوبة
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-map-marker-alt text-danger me-1"></i>المنطقة
              </label>
              <input formControlName="region" 
                     class="form-control form-control-lg shadow-sm" 
                     placeholder="مثال: مدينة نصر"
                     [class.is-invalid]="editPropertyForm.get('region')?.invalid && editPropertyForm.get('region')?.touched">
              <div *ngIf="editPropertyForm.get('region')?.invalid && editPropertyForm.get('region')?.touched" class="invalid-feedback">
                المنطقة مطلوبة
              </div>
            </div>
          </div>

          <!-- Street and Gender -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-road text-secondary me-1"></i>الشارع
              </label>
              <input formControlName="street" 
                     class="form-control form-control-lg shadow-sm" 
                     placeholder="مثال: شارع النصر">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-users text-purple me-1"></i>النوع المفضل
              </label>
              <select formControlName="genderPreference" class="form-select form-select-lg shadow-sm">
                <option value="">اختر النوع المفضل</option>
                <option value="Male">رجال فقط</option>
                <option value="Female">سيدات فقط</option>
                <option value="Mixed">مختلط</option>
              </select>
            </div>
          </div>

          <!-- Description -->
          <div class="row mb-4">
            <div class="col-12">
              <label class="form-label fw-semibold text-dark">
                <i class="fas fa-align-left text-muted me-1"></i>الوصف
              </label>
              <textarea formControlName="description" 
                        class="form-control shadow-sm" 
                        rows="4" 
                        placeholder="اكتب وصف تفصيلي للعقار... (المميزات، الموقع، التجهيزات، إلخ)"
                        style="resize: vertical;"></textarea>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                وصف تفصيلي يساعد في جذب المستأجرين
              </small>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-3 justify-content-end border-top pt-3">
            <button type="button" 
                    class="btn btn-outline-secondary btn-lg px-4 fw-semibold" 
                    (click)="editProperty = null">
              <i class="fas fa-times me-2"></i>إلغاء
            </button>
            <button type="submit" 
                    class="btn btn-success btn-lg px-4 fw-semibold shadow-sm" 
                    [disabled]="editPropertyForm.invalid"
                    [class.disabled]="editPropertyForm.invalid">
              <i class="fas fa-save me-2"></i>حفظ التعديلات
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Stripe Payment Modal -->
  <app-stripe-payment-modal
    [isVisible]="showStripePaymentModal"
    [title]="'إعلان عقار: ' + (advertiseModalProperty?.title || '')"
    [amount]="advertiseModalProperty?.price || 0"
    [commission]="advertiseFee"
    [paymentType]="'advertise'"
    [propertyId]="advertiseModalProperty?.id"
    (modalClosed)="closeAdvertiseModal()"
    (paymentSuccess)="onPaymentSuccess($event)"
    (paymentError)="onPaymentError($event)">
  </app-stripe-payment-modal>



  <!-- Toast للنجاح أو الخطأ -->
  <div *ngIf="toastMessage" class="custom-alert animate__animated animate__fadeInDown" [ngClass]="toastType === 'success' ? 'custom-alert-success' : 'custom-alert-danger'" style="position: fixed; top: 32px; right: 32px; z-index: 2000; min-width: 220px;">
    <span class="custom-alert-icon"><i [ngClass]="toastType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i></span>
    <span class="custom-alert-text">{{ toastMessage }}</span>
    <span class="custom-alert-close" (click)="toastMessage = ''">&times;</span>
  </div>
</div>
